TryHackMe oda adresi : https://tryhackme.com/room/bookstoreoc

Web uygulamalarında dizin taraması, API parametre fuzzing, yerel yetki yükseltme  (local privilege escalation ) gibi işlemlerin yanı sıra temel seviye bir elf dosyasının reverse edilmesi gibi konuları içeren bir challange.

Makineyi başlattıktan sonra hedef IP adresine nmap taraması gerçekleştiriyoruz.

![](../../pics/bookstore1-nmap.png)

Burada 80 portunda web uygulaması 5000 port numarasında ise REST API çalışmaktadır. Python Flask framework kullanıldığı anlaşılabilir servis isminden. robots.txt dosyası içerisinde de /api dizini izin verilmeyen kayıtlar arasında. 

http://IP-ADRESİ:5000/api adresinde API dökümantasyonu bulunuyor.

![](../../pics/Pasted%20image%2020231105005716.png)

Burada dizin taraması yaparak da ilerleyebiliriz. Web enumeration aşamasında uygulamanın erişebildiğimiz gizli veya yayınlanmış dizinleri, dosyaları ne kadar fazla keşfedebilirsek saldırı yüzeyimiz o kadar genişlemektedir.

![](../../pics/Pasted%20image%2020231105005933.png)

Werkzeug debug mode açık olduğundan dolayı /console dizinine erişim sağlayabiliyoruz ancak pin korumalı. 0.14.1 eski versiyonu kullanıldığından dolayı zafiyetli olma olasılığı yüksek.

![](../../pics/Pasted%20image%2020231105010149.png)

80.port üzerinde çalışan web uygulamasına bakıyorum. Sayfaların kaynak kod içerisinde yorum satırlarında ipuçları bırakılmış.
![](../../pics/Pasted%20image%2020231105010646.png)

cyberchef aracını kullanarak encode edilmiş metin çözüldüğünde bir youtube video bağlantı adresi olduğunu tespit ettik.
![](../../pics/Pasted%20image%2020231105010757.png)

Verilen bağlantıya gidildinde Stick bug isimli bir video ile karşılaşıyoruz.

![](../../pics/Pasted%20image%2020231105010845.png)

Kaynak kodlar içerisini kontrol ederken tekrardan bir ipucu daha elde ediyoruz. login.html sayfasında debugger pinin bash history dosyasında olduğunu söylüyor.

![](../../pics/Pasted%20image%2020231105011026.png)

api servisine dönelim. Dökümantasyon içerisinde olmayan id veya author dışında başka yollar olabilir. Ayrıca /api/v2/ olarak belirtilmiş versiyon 1 aktif mi onu da kontrol edebiliriz.

![](../../pics/Pasted%20image%2020231105011522.png)

Her iki versiyondan da başarılı bir response dönmekte. Bu iki api versiyonu için fuzzing yapalım.

![](../../pics/Pasted%20image%2020231105011634.png)

![](../../pics/Pasted%20image%2020231105011824.png)

Fuzzing sonucu, /api/v1 için farklı bir değer ortaya çıktı. Bulunan parametre ile API'ye istek gönderildiğinde hata sayfası çıkmaktadır.

![](../../pics/Pasted%20image%2020231105012025.png)

Bu parametre bir dosya ismi istiyor. Klasik, bilinen yerel dosyalardan /etc/passwd dosyasını girdi olarak yazıyorum. Yerel dizindeki dosyaları okuyabiliyor. Local File Inclusion zafiyeti bulunuyor. Home dizini /home/sid

![](../../pics/Pasted%20image%2020231105012142.png)

user.txt bu dizin içerisinde.

![](../../pics/Pasted%20image%2020231105012303.png)

Aynı zamanda API v1 içerisinde LFI zafiyetinin bulunması ile ilgili bir ipucu api.js dosyasının içerisinde de verilmektedir.

![](../../pics/Pasted%20image%2020231105012531.png)

Bu aşamadan sonra bulunması gereken console pin kodu. Bununla ilgili ipucunu bulmuştuk. bash history dosyası içerisinde olduğu söylenmişti. Bu dosya terminal üzerinde komut geçmişini kaydediyor.

![](../../pics/Pasted%20image%2020231105012751.png)

?show=/home/sid/.bash_history şeklinde istek attığımız zaman API dosya içeriğini response olarak dönmektedir.

![](../../pics/Pasted%20image%2020231105012920.png)

/console dizinine pin kodunu girdikten sonra python konsoluna erişim sağlıyoruz. Hedef üzerinde çalışan bir konsol üzerinden reverse shell bağlantısı kuralım. Bunun için python kullanarak alınan shell bağlantısı koduna ihtiyacımız var.

![](../../pics/Pasted%20image%2020231105013237.png)

Reverse shell payloadını console içerisinde çalıştıralım.

![](../../pics/Pasted%20image%2020231105013338.png)

shell almış olduk ancak /root içerisindeki root.txt dosyasını okumak için yeterli izin yok. Yetki yükseltmek için önemli bir nokta olan suid bit set edilmiş bir dosya bulunmaktadır. SUID bit set edilmiş komut veya dosya yetkisiz kullanıcının root olmasına yardımcı olur.

![](../../pics/Pasted%20image%2020231105013451.png)

SUID biti set edilmiş binaryleri listelemek için kullanılan bir yöntem görseldeki gibidir. Yetki yükseltmek için burada listelenen komutları da deneyebiliriz. Bunun için [GTFOBins](https://gtfobins.github.io/) kaynağını kullanabiliriz. 

![](../../pics/Pasted%20image%2020231105013553.png)

try-harder isimli dosyayı kullanarak yetki yükseltme işlemi gerçekleştireceğim. Bundan önce su, sudo gibi komutları denedim ancak başarılı sonuç alamadım. Dosyayı kendi makineme yüklüyorum.

![](../../pics/Pasted%20image%2020231105014723.png)

radare2 aracını kullanarak açtım ve analizini gerçekleştirdikten sonra ana fonksiyonun olduğu kısma geldim. Reverse işlemine başlamadan önce uygulamayı çalıştırabiliriz.

![](../../pics/Pasted%20image%2020231105014848.png)

Burada kullanıcıdan bir sihirli numara girmesini istiyor ve girilen sayı var_14h değerine alınıyor. Bu input,  0x1116 değeri ile xor işlemini gerçekleştiriyor.
`mov eax, dword [var_14h]`
`xor eax, 0x1116`

Sonraki işlemler incelendiğinde elde edilen sonuç var_10h = 0x5db3 değeri ile tekrardan xor işlemine tabi olunuyor ve sonuç 0x5dcd21f4 değerine eşitse /bin/bash -p olarak yetkili bir şekilde shell açılıyor.
`mov dword [var_ch], eax`
`mov eax,dword [var_10h] ; eax=var_10h=0x5db3`
`xor dword[var_ch], eax`
`cmp dword[var_ch], 0x5dcd21f4`
`jne 0x823 ; jump if not equal var_ch and 0x5dcd21f4` 

Benzer şekilde, ghidra ile decompile edilmiş assembly kodlarını görebiliriz.

![](../../pics/Pasted%20image%2020231105020304.png)

xor işleminin tersi yine kendisidir yani elimizde olan diğer sayıları xor işleminden geçirirsem vermem gereken sayıyı tespit edeceğim. Python3 içerisinde bu xor işlemi için "^" sembolü kullanılmaktadır.

![](../../pics/Pasted%20image%2020231105020200.png)

![](../../pics/Pasted%20image%2020231105020344.png)

./try-harder programı için doğru numara değerini verdiğimiz zaman root kullanıcısı olduk. /root dizinine erişim sağlayabiliriz.

![](../../pics/Pasted%20image%2020231105020625.png)
# Kaynaklar
* https://www.hackingarticles.in/linux-privilege-escalation-using-suid-binaries/
* https://gtfobins.github.io/
* https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/web-api-pentesting
